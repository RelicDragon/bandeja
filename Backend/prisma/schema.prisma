generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DB_URL")
}

model User {
  id                         String               @id @default(cuid())
  phone                      String?              @unique
  email                      String?              @unique
  telegramId                 String?              @unique
  telegramUsername           String?
  appleSub                   String?              @unique
  appleEmail                 String?
  appleEmailVerified         Boolean              @default(false)
  googleId                   String?              @unique
  googleEmail                String?
  googleEmailVerified        Boolean              @default(false)
  firstName                  String?
  lastName                   String?
  avatar                     String?
  originalAvatar             String?
  authProvider               AuthProvider
  passwordHash               String?
  isActive                   Boolean              @default(true)
  level                      Float                @default(1.0)
  socialLevel                Float                @default(1.0)
  reliability                Float                @default(0)
  totalPoints                Int                  @default(0)
  gamesPlayed                Int                  @default(0)
  gamesWon                   Int                  @default(0)
  wallet                     Int                  @default(0)
  currentCityId              String?
  lastUserIP                 String?
  latitudeByIP               Float?
  longitudeByIP              Float?
  language                   String?              @default("auto")
  timeFormat                 String               @default("auto")
  weekStart                  String               @default("auto")
  preferredHandLeft          Boolean              @default(false)
  preferredHandRight         Boolean              @default(false)
  preferredCourtSideLeft     Boolean              @default(false)
  preferredCourtSideRight    Boolean              @default(false)
  createdAt                  DateTime             @default(now())
  updatedAt                  DateTime             @updatedAt
  isAdmin                    Boolean              @default(false)
  isDeveloper                Boolean              @default(false)
  isTrainer                  Boolean              @default(false)
  canCreateTournament        Boolean              @default(false)
  canCreateLeague            Boolean              @default(false)
  gender                     Gender               @default(PREFER_NOT_TO_SAY)
  genderIsSet                Boolean              @default(false)
  approvedLevel               Boolean              @default(false)
  approvedById                String?
  approvedWhen                DateTime?
  favoriteTrainerId           String?
  sendTelegramMessages       Boolean              @default(true)
  sendTelegramInvites        Boolean              @default(true)
  sendTelegramDirectMessages Boolean              @default(true)
  sendTelegramReminders      Boolean              @default(true)
  sendTelegramWalletNotifications Boolean         @default(true)
  chatMessages               ChatMessage[]
  participateInGames         GameParticipant[]    @relation("ParticipantUser")
  participantsInvitedByMe     GameParticipant[]    @relation("ParticipantInvitedBy")
  userChats1                 UserChat[]           @relation("UserChat1")
  userChats2                 UserChat[]           @relation("UserChat2")
  pinnedUserChats            PinnedUserChat[]
  messageReactions           MessageReaction[]
  messageReadReceipts        MessageReadReceipt[]
  currentCity                City?                @relation("UserCurrentCity", fields: [currentCityId], references: [id])
  approvedBy                 User?                @relation("UserApprovedBy", fields: [approvedById], references: [id])
  approvedUsers              User[]               @relation("UserApprovedBy")
  favoriteTrainer            User?                @relation("UserFavoriteTrainer", fields: [favoriteTrainerId], references: [id], onDelete: SetNull)
  usersWithFavoriteTrainer   User[]               @relation("UserFavoriteTrainer")
  favoriteClubs              UserFavoriteClub[]
  favoriteUsers              UserFavoriteUser[]   @relation("UserFavorites")
  favoritedBy                UserFavoriteUser[]   @relation("UserFavoritedBy")
  interactionsFrom           UserInteraction[]    @relation("InteractionFromUser")
  interactionsTo             UserInteraction[]    @relation("InteractionToUser")
  teamPlayers                TeamPlayer[]
  roundOutcomes              RoundOutcome[]
  gameOutcomes               GameOutcome[]
  gameTeamPlayers            GameTeamPlayer[]
  bugs                       Bug[]
  bugParticipants            BugParticipant[]
  lundaProfile               LundaProfile?
  transactionsFrom           Transaction[]        @relation("TransactionFromUser")
  transactionsTo             Transaction[]        @relation("TransactionToUser")
  levelChangeEvents          LevelChangeEvent[]
  leagueParticipants         LeagueParticipant[]
  leagueTeamPlayers          LeagueTeamPlayer[]
  sendPushMessages           Boolean              @default(true)
  sendPushInvites            Boolean              @default(true)
  sendPushDirectMessages     Boolean              @default(true)
  sendPushReminders          Boolean              @default(true)
  sendPushWalletNotifications Boolean             @default(true)
  allowMessagesFromNonContacts Boolean            @default(true)
  pushTokens                 PushToken[]
  messageReports             MessageReport[]      @relation("MessageReportReporter")
  blockedUsers               BlockedUser[]        @relation("UserBlocked")
  blockedBy                    BlockedUser[]        @relation("UserBlockedBy")
  chatMutes                   ChatMute[]
  gameSubscriptions           GameSubscription[]
  groupChannelParticipants    GroupChannelParticipant[]
  groupInvitesSent            GroupChannelInvite[] @relation("GroupInviteSender")
  groupInvitesReceived        GroupChannelInvite[] @relation("GroupInviteReceiver")
  betsCreated                 Bet[]                @relation("BetCreator")
  betsAccepted                Bet[]                @relation("BetAcceptor")
  betsWon                     Bet[]                @relation("BetWinner")
  betParticipants             BetParticipant[]
  messageTranslations         MessageTranslation[]
  chatDrafts                  ChatDraft[]
  notificationPreferences     NotificationPreference[]
  pollVotes              PollVote[]
  marketItems            MarketItem[]
  trainedGames           Game[]               @relation("GameTrainer")

  @@index([phone])
  @@index([telegramId])
  @@index([currentCityId])
  @@index([level])
  @@index([totalPoints])
  @@index([approvedById])
}

model IpLocationCache {
  id        String   @id @default(cuid())
  ip        String   @unique
  latitude  Float
  longitude Float
  meta      Json
  createdAt DateTime @default(now())

  @@index([ip])
}

model LundaProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cookie    String?
  metadata  Json // Store the entire player data response from Lunda API
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model City {
  id                     String   @id @default(cuid())
  name                   String
  country                String
  timezone               String
  subAdministrativeArea  String?
  administrativeArea     String?
  latitude               Float?
  longitude              Float?
  clubsCount             Int      @default(0)
  isCorrect              Boolean  @default(false)
  telegramGroupId        String?
  telegramPinnedMessageId String?
  telegramPinnedLanguage String   @default("en-US")
  isActive               Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  clubs                  Club[]
  users                  User[]   @relation("UserCurrentCity")
  leagues                League[]
  games                  Game[]
  gameSubscriptions      GameSubscription[]
  groupChannels          GroupChannel[] @relation("GroupChannelCity")
  marketItems            MarketItem[]

  @@index([isActive])
  @@index([clubsCount])
}

model Club {
  id                   String             @id @default(cuid())
  name                 String
  normalizedName       String
  description          String?
  address              String
  cityId               String
  phone                String?
  email                String?
  website              String?
  latitude             Float?
  longitude            Float?
  openingTime          String?
  closingTime          String?
  amenities            Json?
  isActive             Boolean            @default(true)
  isBar                Boolean            @default(false)
  isForPlaying         Boolean            @default(true)
  integrationScriptName String?
  integrationScriptDateIndependent Boolean? @default(false)
  integrationConfig    Json?
  ptMeta               Json?    @map("pt_meta")
  courtsNumber         Int                @default(0)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  city                 City               @relation(fields: [cityId], references: [id], onDelete: Cascade)
  courts               Court[]
  games                Game[]
  favoritedBy          UserFavoriteClub[]
  leagues              League[]

  @@index([cityId])
  @@index([isActive])
  @@index([integrationScriptName])
  @@index([normalizedName])
}

model Court {
  id             String      @id @default(cuid())
  name           String
  clubId         String
  courtType      String?
  isIndoor       Boolean     @default(false)
  surfaceType    String?
  pricePerHour   Float?
  externalCourtId String?
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  club           Club        @relation(fields: [clubId], references: [id], onDelete: Cascade)
  games          Game[]
  gameCourts     GameCourt[]
  matches        Match[]

  @@index([clubId])
  @@index([isActive])
  @@index([externalCourtId])
}

model Game {
  id                     String              @id @default(cuid())
  entityType             EntityType
  gameType               GameType
  name                   String?
  description            String?
  avatar                 String?
  originalAvatar         String?
  clubId                 String?
  courtId                String?
  cityId                 String
  startTime              DateTime
  endTime                DateTime
  maxParticipants        Int                 @default(4)
  minParticipants        Int                 @default(2)
  minLevel               Float?
  maxLevel               Float?
  isPublic               Boolean             @default(true)
  affectsRating          Boolean             @default(true)
  anyoneCanInvite        Boolean             @default(false)
  resultsByAnyone        Boolean             @default(false)
  allowDirectJoin        Boolean             @default(false)
  hasBookedCourt         Boolean             @default(false)
  afterGameGoToBar       Boolean             @default(false)
  hasFixedTeams          Boolean             @default(false)
  genderTeams            GenderTeam          @default(ANY)
  teamsReady             Boolean             @default(false)
  participantsReady      Boolean             @default(false)
  status                 GameStatus          @default(ANNOUNCED)
  resultsStatus          ResultsStatus       @default(NONE)
  resultsMeta            Json?
  fixedNumberOfSets      Int                 @default(0)
  maxTotalPointsPerSet   Int                 @default(0)
  maxPointsPerTeam       Int                 @default(0)
  winnerOfGame           WinnerOfGame        @default(BY_MATCHES_WON)
  winnerOfMatch          WinnerOfMatch       @default(BY_SCORES)
  matchGenerationType    MatchGenerationType @default(HANDMADE)
  prohibitMatchesEditing Boolean             @default(false)
  pointsPerWin           Int                 @default(0)
  pointsPerLoose         Int                 @default(0)
  pointsPerTie           Int                 @default(0)
  ballsInGames           Boolean             @default(false)
  mediaUrls              String[]
  photosCount            Int                 @default(0)
  mainPhotoId            String?
  resultsSentToTelegram  Boolean             @default(false)
  parentId               String?
  trainerId              String?
  leagueRoundId          String?
  leagueGroupId          String?
  timeIsSet              Boolean             @default(false)
  finishedDate           DateTime?
  priceTotal             Float?
  priceType              PriceType           @default(NOT_KNOWN)
  priceCurrency          PriceCurrency?
  metadata               Json?
  lastMessagePreview     String?             @db.VarChar(500)
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  club                   Club?               @relation(fields: [clubId], references: [id])
  court                  Court?              @relation(fields: [courtId], references: [id])
  city                   City                @relation(fields: [cityId], references: [id], onDelete: Cascade)
  parent                 Game?               @relation("GameHierarchy", fields: [parentId], references: [id])
  children               Game[]              @relation("GameHierarchy")
  trainer                User?               @relation("GameTrainer", fields: [trainerId], references: [id], onDelete: SetNull)
  leagueRound            LeagueRound?        @relation(fields: [leagueRoundId], references: [id], onDelete: SetNull)
  leagueGroup            LeagueGroup?        @relation(fields: [leagueGroupId], references: [id], onDelete: SetNull)
  participants           GameParticipant[]
  rounds                 Round[]
  outcomes               GameOutcome[]
  fixedTeams             GameTeam[]
  gameCourts             GameCourt[]
  levelChangeEvents      LevelChangeEvent[]
  leagueSeason           LeagueSeason?       @relation("GameLeagueSeason")
  faqs                   GameFaq[]
  bets                   Bet[]

  @@index([clubId])
  @@index([courtId])
  @@index([cityId])
  @@index([startTime])
  @@index([status])
  @@index([entityType])
  @@index([parentId])
  @@index([trainerId])
  @@index([leagueRoundId])
  @@index([leagueGroupId])
  @@index([affectsRating])
  @@index([resultsStatus])
  @@index([hasFixedTeams])
  @@index([timeIsSet, clubId, startTime])
  @@index([endTime])
  @@index([timeIsSet, courtId])
}

model GameFaq {
  id        String   @id @default(cuid())
  gameId    String
  question  String
  answer    String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([order])
}

model GameParticipant {
  id               String             @id @default(cuid())
  userId           String
  gameId           String
  role             ParticipantRole
  status           ParticipantStatus  @default(PLAYING)
  joinedAt         DateTime           @default(now())
  stats            Json?
  invitedByUserId  String?
  inviteMessage    String?
  inviteExpiresAt  DateTime?
  game             Game               @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user             User               @relation("ParticipantUser", fields: [userId], references: [id], onDelete: Cascade)
  invitedByUser    User?              @relation("ParticipantInvitedBy", fields: [invitedByUserId], references: [id], onDelete: SetNull)

  @@unique([userId, gameId])
  @@index([userId])
  @@index([gameId])
  @@index([role])
  @@index([status])
}

model Round {
  id          String         @id @default(cuid())
  gameId      String
  roundNumber Int
  metadata    Json?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  game        Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)
  matches     Match[]
  outcomes    RoundOutcome[]

  @@unique([gameId, roundNumber])
  @@index([gameId])
}

model Match {
  id          String   @id @default(cuid())
  roundId     String
  matchNumber Int
  winnerId    String?
  courtId     String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  round       Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)
  winner      Team?    @relation("MatchWinner", fields: [winnerId], references: [id])
  court       Court?   @relation(fields: [courtId], references: [id])
  teams       Team[]
  sets        Set[]

  @@index([roundId])
  @@index([winnerId])
  @@index([courtId])
}

model Team {
  id         String       @id @default(cuid())
  matchId    String
  teamNumber Int
  score      Int          @default(0)
  metadata   Json?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  match      Match        @relation(fields: [matchId], references: [id], onDelete: Cascade)
  players    TeamPlayer[]
  wonMatches Match[]      @relation("MatchWinner")

  @@index([matchId])
}

model TeamPlayer {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  createdAt DateTime @default(now())
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Set {
  id         String   @id @default(cuid())
  matchId    String
  setNumber  Int
  teamAScore Int      @default(0)
  teamBScore Int      @default(0)
  isTieBreak Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  match      Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@unique([matchId, setNumber])
  @@index([matchId])
}

model RoundOutcome {
  id          String   @id @default(cuid())
  roundId     String
  userId      String
  levelChange Float    @default(0)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  round       Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roundId, userId])
  @@index([roundId])
  @@index([userId])
}

model GameOutcome {
  id                String   @id @default(cuid())
  gameId            String
  userId            String
  levelBefore       Float
  levelAfter        Float
  levelChange       Float
  reliabilityBefore Float
  reliabilityAfter  Float
  reliabilityChange Float
  pointsEarned      Int      @default(0)
  position          Int?
  isWinner          Boolean  @default(false)
  wins              Int      @default(0)
  ties              Int      @default(0)
  losses            Int      @default(0)
  scoresMade        Int      @default(0)
  scoresLost        Int      @default(0)
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  game              Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId])
  @@index([gameId])
  @@index([userId])
  @@index([isWinner])
}

model GameTeam {
  id         String           @id @default(cuid())
  gameId     String
  teamNumber Int
  name       String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  game       Game             @relation(fields: [gameId], references: [id], onDelete: Cascade)
  players    GameTeamPlayer[]

  @@unique([gameId, teamNumber])
  @@index([gameId])
}

model GameTeamPlayer {
  id         String   @id @default(cuid())
  gameTeamId String
  userId     String
  createdAt  DateTime @default(now())
  gameTeam   GameTeam @relation(fields: [gameTeamId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gameTeamId, userId])
  @@index([gameTeamId])
  @@index([userId])
}

model UserInteraction {
  id                String   @id @default(cuid())
  fromUserId        String
  toUserId          String
  count             Int      @default(1)
  lastInteractionAt DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  fromUser          User     @relation("InteractionFromUser", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser            User     @relation("InteractionToUser", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([count])
}

model UserChat {
  id                  String           @id @default(cuid())
  user1Id             String
  user2Id             String
  user1allowed        Boolean          @default(true)
  user2allowed        Boolean          @default(true)
  lastMessagePreview  String?          @db.VarChar(500)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  user1               User             @relation("UserChat1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2         User             @relation("UserChat2", fields: [user2Id], references: [id], onDelete: Cascade)
  pinnedByUsers PinnedUserChat[]

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@index([updatedAt])
}

model PinnedUserChat {
  id         String   @id @default(cuid())
  userId     String
  userChatId String
  pinnedAt   DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userChat   UserChat @relation(fields: [userChatId], references: [id], onDelete: Cascade)

  @@unique([userId, userChatId])
  @@index([userId])
  @@index([userChatId])
}

model ChatMessage {
  id                 String               @id @default(cuid())
  chatContextType    ChatContextType      @default(GAME)
  contextId          String
  gameId             String?
  senderId           String?
  content            String?
  contentSearchable  String?
  mediaUrls       String[]
  thumbnailUrls   String[]
  mentionIds      String[]
  state           MessageState         @default(SENT)
  chatType        ChatType             @default(PUBLIC)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  replyToId       String?
  replyTo         ChatMessage?         @relation("MessageReply", fields: [replyToId], references: [id])
  replies         ChatMessage[]        @relation("MessageReply")
  sender          User?                @relation(fields: [senderId], references: [id], onDelete: Cascade)
  reactions       MessageReaction[]
  readReceipts    MessageReadReceipt[]
  reports         MessageReport[]
  translations    MessageTranslation[]
  poll            Poll?
  pollId          String?              @unique

  @@index([chatContextType, contextId])
  @@index([gameId])
  @@index([senderId])
  @@index([createdAt])
  @@index([state])
  @@index([replyToId])
  @@index([chatType])
  @@index([contextId])
}

model Poll {
  id              String       @id @default(cuid())
  question        String
  type            PollType     @default(CLASSICAL)
  isAnonymous     Boolean      @default(false)
  allowsMultipleAnswers Boolean @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  message         ChatMessage  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId       String       @unique

  options         PollOption[]
  votes           PollVote[]
}

model PollOption {
  id        String     @id @default(cuid())
  text      String
  order     Int
  isCorrect Boolean    @default(false) // For QUIZ type
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  pollId    String
  votes     PollVote[] // Votes for this specific option

  @@index([pollId])
}

model PollVote {
  id           String     @id @default(cuid())
  poll         Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  pollId       String
  option       PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  optionId     String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  createdAt    DateTime   @default(now())

  @@unique([userId, optionId])
  @@index([pollId])
  @@index([userId])
  @@index([optionId])
}

model ChatMute {
  id              String          @id @default(cuid())
  userId          String
  chatContextType ChatContextType
  contextId       String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chatContextType, contextId])
  @@index([userId])
  @@index([chatContextType, contextId])
}

model ChatDraft {
  id              String          @id @default(cuid())
  userId          String
  chatContextType ChatContextType
  contextId       String
  chatType        ChatType        @default(PUBLIC)
  content         String?
  mentionIds      String[]
  updatedAt       DateTime        @updatedAt
  createdAt       DateTime        @default(now())
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chatContextType, contextId, chatType])
  @@index([userId])
  @@index([chatContextType, contextId])
  @@index([updatedAt])
}

model MessageReaction {
  id        String      @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime    @default(now())
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model MessageReadReceipt {
  id        String      @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime    @default(now())
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model MessageTranslation {
  id          String      @id @default(cuid())
  messageId   String
  message     ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  languageCode String     @db.VarChar(10)
  translation String
  createdBy   String
  createdByUser User      @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt   DateTime    @default(now())

  @@unique([messageId, languageCode])
  @@index([messageId])
  @@index([languageCode])
}

model UserFavoriteClub {
  id        String   @id @default(cuid())
  userId    String
  clubId    String
  createdAt DateTime @default(now())
  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, clubId])
  @@index([userId])
  @@index([clubId])
}

model UserFavoriteUser {
  id             String   @id @default(cuid())
  userId         String
  favoriteUserId String
  createdAt      DateTime @default(now())
  user           User     @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)
  favoriteUser   User     @relation("UserFavoritedBy", fields: [favoriteUserId], references: [id], onDelete: Cascade)

  @@unique([userId, favoriteUserId])
  @@index([userId])
  @@index([favoriteUserId])
}

model BlockedUser {
  id            String   @id @default(cuid())
  userId        String
  blockedUserId String
  createdAt     DateTime @default(now())
  user          User     @relation("UserBlocked", fields: [userId], references: [id], onDelete: Cascade)
  blockedUser   User     @relation("UserBlockedBy", fields: [blockedUserId], references: [id], onDelete: Cascade)

  @@unique([userId, blockedUserId])
  @@index([userId])
  @@index([blockedUserId])
}

enum AuthProvider {
  PHONE
  TELEGRAM
  APPLE
  GOOGLE
}

enum Gender {
  MALE
  FEMALE
  PREFER_NOT_TO_SAY
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum GameType {
  CLASSIC
  AMERICANO
  MEXICANO
  ROUND_ROBIN
  WINNER_COURT
  CUSTOM
}

enum EntityType {
  GAME
  TOURNAMENT
  LEAGUE
  LEAGUE_SEASON
  BAR
  TRAINING
}

enum GenderTeam {
  ANY
  MEN
  WOMEN
  MIX_PAIRS
}

enum ParticipantRole {
  OWNER
  ADMIN
  PARTICIPANT
}

enum ParticipantStatus {
  GUEST
  INVITED
  IN_QUEUE
  PLAYING
  NON_PLAYING
}

enum MessageState {
  SENT
  DELIVERED
  READ
}

enum ChatType {
  PUBLIC
  PRIVATE
  ADMINS
  PHOTOS
}

enum ChatContextType {
  GAME
  BUG
  USER
  GROUP
}

enum PollType {
  CLASSICAL
  MULTI_ANSWER
  QUIZ
}

enum MarketItemTradeType {
  BUY_IT_NOW
  SUGGESTED_PRICE
  AUCTION
}

enum MarketItemStatus {
  ACTIVE
  SOLD
  RESERVED
  WITHDRAWN
}

model TelegramOtp {
  id            String   @id @default(cuid())
  code          String   @db.VarChar(6)
  telegramId    String   @db.VarChar(255)
  username      String?  @db.VarChar(255)
  firstName     String?  @db.VarChar(255)
  lastName      String?  @db.VarChar(255)
  languageCode  String?  @db.VarChar(10)
  chatId        String?  @db.VarChar(255)
  textMessageId String?  @db.VarChar(255)
  codeMessageId String?  @db.VarChar(255)
  expiresAt     DateTime
  createdAt     DateTime @default(now())

  @@index([code])
  @@index([telegramId])
  @@index([expiresAt])
}

model Bug {
  id                   String           @id @default(cuid())
  text                 String
  senderId             String
  status               BugStatus        @default(CREATED)
  bugType              BugType          @default(BUG)
  lastMessagePreview   String?          @db.VarChar(500)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  sender               User             @relation(fields: [senderId], references: [id], onDelete: Cascade)
  participants         BugParticipant[]
  groupChannel         GroupChannel?

  @@index([senderId])
  @@index([status])
  @@index([bugType])
}

model BugParticipant {
  id       String   @id @default(cuid())
  bugId    String
  userId   String
  joinedAt DateTime @default(now())
  bug      Bug      @relation(fields: [bugId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([bugId, userId])
  @@index([bugId])
  @@index([userId])
}

model MarketItemCategory {
  id        String       @id @default(cuid())
  name      String
  order     Int          @default(0)
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  items     MarketItem[]

  @@index([isActive])
  @@index([order])
}

model MarketItem {
  id              String                @id @default(cuid())
  sellerId        String
  categoryId      String
  cityId          String
  title           String
  description     String?
  mediaUrls       String[]
  tradeTypes      MarketItemTradeType[] @default([])
  priceCents      Int?
  currency        PriceCurrency         @default(EUR)
  auctionEndsAt   DateTime?
  status          MarketItemStatus      @default(ACTIVE)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  seller          User                  @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  category        MarketItemCategory    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  city            City                  @relation(fields: [cityId], references: [id], onDelete: Cascade)
  groupChannel    GroupChannel?

  @@index([sellerId])
  @@index([categoryId])
  @@index([cityId])
  @@index([status])
  @@index([createdAt])
}

model GroupChannel {
  id                   String                  @id @default(cuid())
  name                 String
  avatar               String?
  originalAvatar       String?
  cityId               String?
  bugId                String?                 @unique
  marketItemId         String?                 @unique
  isChannel            Boolean                 @default(false)
  isPublic             Boolean                 @default(true)
  participantsCount    Int                     @default(0)
  lastMessagePreview   String?                 @db.VarChar(500)
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  city                 City?                   @relation("GroupChannelCity", fields: [cityId], references: [id], onDelete: SetNull)
  bug                  Bug?                    @relation(fields: [bugId], references: [id], onDelete: Cascade)
  marketItem           MarketItem?              @relation(fields: [marketItemId], references: [id], onDelete: Cascade)
  participants         GroupChannelParticipant[]
  invites              GroupChannelInvite[]

  @@index([isPublic])
  @@index([isChannel])
  @@index([cityId])
  @@index([bugId])
  @@index([marketItemId])
}

model GroupChannelParticipant {
  id            String       @id @default(cuid())
  groupChannelId String
  userId        String
  role          ParticipantRole @default(PARTICIPANT)
  joinedAt      DateTime     @default(now())
  hidden        Boolean      @default(false)
  groupChannel  GroupChannel @relation(fields: [groupChannelId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupChannelId, userId])
  @@index([groupChannelId])
  @@index([userId])
  @@index([hidden])
}

model GroupChannelInvite {
  id            String       @id @default(cuid())
  groupChannelId String
  senderId      String
  receiverId   String
  status        InviteStatus @default(PENDING)
  message       String?
  expiresAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  groupChannel  GroupChannel @relation(fields: [groupChannelId], references: [id], onDelete: Cascade)
  sender        User         @relation("GroupInviteSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver      User         @relation("GroupInviteReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([groupChannelId])
  @@index([receiverId])
  @@index([status])
  @@index([expiresAt])
}

enum BugStatus {
  CREATED
  CONFIRMED
  IN_PROGRESS
  TEST
  FINISHED
  ARCHIVED
}

enum BugType {
  BUG
  CRITICAL
  SUGGESTION
  QUESTION
  TASK
}

enum GameStatus {
  ANNOUNCED
  STARTED
  FINISHED
  ARCHIVED
}

enum ResultsStatus {
  NONE
  IN_PROGRESS
  FINAL
}

enum WinnerOfGame {
  BY_MATCHES_WON
  BY_POINTS
  BY_SCORES_DELTA
  PLAYOFF_FINALS
}

enum WinnerOfMatch {
  BY_SETS
  BY_SCORES
}

enum MatchGenerationType {
  HANDMADE
  FIXED
  RANDOM
  ROUND_ROBIN
  ESCALERA
  RATING
  WINNERS_COURT
}

enum BetType {
  SOCIAL
  POOL
}

enum BetPoolSide {
  WITH_CREATOR
  AGAINST_CREATOR
}

enum BetStatus {
  OPEN
  ACCEPTED
  RESOLVED
  CANCELLED
  NEEDS_REVIEW
}

model GameCourt {
  id        String   @id @default(cuid())
  gameId    String
  courtId   String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  court     Court    @relation(fields: [courtId], references: [id], onDelete: Cascade)

  @@unique([gameId, courtId])
  @@unique([gameId, order])
  @@index([gameId])
  @@index([courtId])
}

model Goods {
  id              String           @id @default(cuid())
  name            String
  price           Int
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  transactionRows TransactionRow[]

  @@index([name])
}

model Transaction {
  id              String           @id @default(cuid())
  type            TransactionType
  total           Int
  fromUserId      String?
  toUserId        String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  fromUser        User?            @relation("TransactionFromUser", fields: [fromUserId], references: [id], onDelete: SetNull)
  toUser          User?            @relation("TransactionToUser", fields: [toUserId], references: [id], onDelete: SetNull)
  transactionRows TransactionRow[]

  @@index([fromUserId])
  @@index([toUserId])
  @@index([type])
  @@index([createdAt])
}

model TransactionRow {
  id            String      @id @default(cuid())
  transactionId String
  goodsId       String?
  name          String
  price         Int
  qty           Int
  total         Int
  createdAt     DateTime    @default(now())
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  goods         Goods?      @relation(fields: [goodsId], references: [id], onDelete: SetNull)

  @@index([transactionId])
  @@index([goodsId])
}

enum TransactionType {
  NEW_COIN
  TRANSFER
  PURCHASE
  REFUND
}

model LevelChangeEvent {
  id             String               @id @default(cuid())
  userId         String
  levelBefore    Float
  levelAfter     Float
  eventType      LevelChangeEventType
  gameId         String?
  linkEntityType EntityType?
  createdAt      DateTime             @default(now())
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  game           Game?                @relation(fields: [gameId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([gameId])
  @@index([eventType])
  @@index([createdAt])
}

enum LevelChangeEventType {
  GAME
  LUNDA
  SET
  OTHER
  SOCIAL_BAR
  SOCIAL_PARTICIPANT
}

model League {
  id            String              @id @default(cuid())
  name          String
  description   String?
  hasFixedTeams Boolean             @default(false)
  cityId        String
  clubId        String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  city          City                @relation(fields: [cityId], references: [id], onDelete: Cascade)
  club          Club?               @relation(fields: [clubId], references: [id], onDelete: SetNull)
  seasons       LeagueSeason[]
  participants  LeagueParticipant[]

  @@index([cityId])
  @@index([clubId])
}

model LeagueSeason {
  id              String              @id
  leagueId        String
  orderIndex      Int
  movePlayersRule Json?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  league          League              @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  game            Game?               @relation("GameLeagueSeason", fields: [id], references: [id], onDelete: Cascade)
  groups          LeagueGroup[]
  participants    LeagueParticipant[]
  rounds          LeagueRound[]

  @@index([leagueId])
  @@index([orderIndex])
}

model LeagueGroup {
  id             String              @id @default(cuid())
  leagueSeasonId String
  name           String
  color          String?
  betterGroupId  String?
  worseGroupId   String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  leagueSeason   LeagueSeason        @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  betterGroup    LeagueGroup?        @relation("LeagueGroupBetter", fields: [betterGroupId], references: [id], onDelete: SetNull)
  worseGroup     LeagueGroup?        @relation("LeagueGroupWorse", fields: [worseGroupId], references: [id], onDelete: SetNull)
  betterGroups   LeagueGroup[]       @relation("LeagueGroupBetter")
  worseGroups    LeagueGroup[]       @relation("LeagueGroupWorse")
  participants   LeagueParticipant[]
  games          Game[]

  @@index([leagueSeasonId])
}

model LeagueTeam {
  id           String              @id @default(cuid())
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  players      LeagueTeamPlayer[]
  participants LeagueParticipant[]

  @@index([id])
}

model LeagueTeamPlayer {
  id           String     @id @default(cuid())
  leagueTeamId String
  userId       String
  createdAt    DateTime   @default(now())
  leagueTeam   LeagueTeam @relation(fields: [leagueTeamId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([leagueTeamId, userId])
  @@index([leagueTeamId])
  @@index([userId])
}

model LeagueParticipant {
  id              String                @id @default(cuid())
  leagueId        String
  leagueSeasonId  String
  participantType LeagueParticipantType
  userId          String?
  leagueTeamId    String?
  currentGroupId  String?
  points          Int                   @default(0)
  wins            Int                   @default(0)
  ties            Int                   @default(0)
  losses          Int                   @default(0)
  scoreDelta      Int                   @default(0)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  league          League                @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  leagueSeason    LeagueSeason          @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  user            User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  leagueTeam      LeagueTeam?           @relation(fields: [leagueTeamId], references: [id], onDelete: Cascade)
  currentGroup    LeagueGroup?          @relation(fields: [currentGroupId], references: [id], onDelete: SetNull)

  @@index([leagueId])
  @@index([leagueSeasonId])
  @@index([userId])
  @@index([leagueTeamId])
  @@index([currentGroupId])
  @@index([participantType])
}

model LeagueRound {
  id               String       @id @default(cuid())
  leagueSeasonId   String
  orderIndex       Int
  sentStartMessage Boolean      @default(false)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  leagueSeason     LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  games            Game[]

  @@index([leagueSeasonId])
  @@index([orderIndex])
}

enum LeagueParticipantType {
  USER
  TEAM
}

enum PriceType {
  PER_PERSON
  PER_TEAM
  TOTAL
  NOT_KNOWN
  FREE
}

enum PriceCurrency {
  EUR
  RSD
  RUB
}

model PushToken {
  id        String       @id @default(cuid())
  userId    String
  token     String
  platform  PushPlatform
  deviceId  String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@index([userId])
  @@index([token])
}

model DeletedUser {
  id               String   @id @default(cuid())
  originalUserId   String
  phone            String?
  email            String?
  telegramId       String?
  telegramUsername String?
  firstName        String?
  lastName         String?
  avatar           String?
  originalAvatar   String?
  passwordHash     String?
  currentCityId    String?
  deletedAt        DateTime @default(now())

  @@index([originalUserId])
  @@index([deletedAt])
}

enum PushPlatform {
  IOS
  ANDROID
  WEB
}

enum NotificationChannelType {
  PUSH
  TELEGRAM
  WHATSAPP
  VIBER
}

model NotificationPreference {
  id                      String                 @id @default(cuid())
  userId                  String
  channelType             NotificationChannelType
  sendMessages            Boolean                @default(true)
  sendInvites             Boolean                @default(true)
  sendDirectMessages      Boolean                @default(true)
  sendReminders           Boolean                @default(true)
  sendWalletNotifications      Boolean                @default(true)
  sendMarketplaceNotifications Boolean                @default(true)
  createdAt                    DateTime               @default(now())
  updatedAt                    DateTime               @updatedAt
  user                         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channelType])
  @@index([userId])
}

model MessageReport {
  id          String              @id @default(cuid())
  messageId   String
  reporterId  String
  reason      MessageReportReason
  description String?
  status      MessageReportStatus @default(PENDING)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  message     ChatMessage         @relation(fields: [messageId], references: [id], onDelete: Cascade)
  reporter    User                @relation("MessageReportReporter", fields: [reporterId], references: [id], onDelete: Cascade)

  @@unique([messageId, reporterId])
  @@index([messageId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
}

enum MessageReportReason {
  SPAM
  HARASSMENT
  INAPPROPRIATE_CONTENT
  FAKE_INFORMATION
  OTHER
}

enum MessageReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

model GameSubscription {
  id            String      @id @default(cuid())
  userId        String
  cityId        String
  clubIds       String[]
  entityTypes   EntityType[]
  dayOfWeek     Int[]
  startDate     DateTime?
  endDate       DateTime?
  startTime     String?
  endTime       String?
  minLevel      Float?
  maxLevel      Float?
  myGenderOnly  Boolean     @default(false)
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  city          City        @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([cityId])
  @@index([isActive])
  @@index([userId, isActive, cityId])
}

model Bet {
  id               String    @id @default(cuid())
  gameId           String
  creatorId        String
  type             BetType   @default(SOCIAL)
  status           BetStatus @default(OPEN)
  condition        Json      // BetCondition type
  stakeType        String    @default("COINS") // COINS or TEXT
  stakeCoins       Int?      // Amount if stakeType is COINS
  stakeText        String?  // Text if stakeType is TEXT
  rewardType       String    @default("COINS") // COINS or TEXT
  rewardCoins      Int?      // Amount if rewardType is COINS
  rewardText       String?   // Text if rewardType is TEXT
  poolTotalCoins   Int?      // POOL: total coins in pool
  acceptedBy       String?
  acceptedAt      DateTime?
  winnerId         String?   // Set when resolved (SOCIAL single winner; POOL null)
  resolvedAt       DateTime?
  resolutionReason String?
  metadata         Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  game             Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  creator          User      @relation("BetCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  acceptedByUser   User?     @relation("BetAcceptor", fields: [acceptedBy], references: [id], onDelete: SetNull)
  winner           User?     @relation("BetWinner", fields: [winnerId], references: [id], onDelete: SetNull)
  participants     BetParticipant[]

  @@index([gameId])
  @@index([creatorId])
  @@index([status])
  @@index([gameId, status])
  @@index([acceptedBy])
}

model BetParticipant {
  id        String      @id @default(cuid())
  betId     String
  userId    String
  side      BetPoolSide
  createdAt DateTime    @default(now())
  bet       Bet         @relation(fields: [betId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([betId, userId])
  @@index([betId])
  @@index([userId])
}

model AppVersionRequirement {
  id             String   @id @default(cuid())
  platform       String   @unique
  minBuildNumber Int
  minVersion     String
  isBlocking     Boolean  @default(false)
  message        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([platform])
}

model UserGameNote {
  id        String   @id @default(cuid())
  userId    String
  gameId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, gameId])
  @@index([userId])
  @@index([gameId])
}
