# Map to detect bots/crawlers
map $http_user_agent $is_bot {
    default 0;
    ~*bot 1;
    ~*crawler 1;
    ~*spider 1;
    ~*slurp 1;
    ~*facebookexternalhit 1;
    ~*facebookcatalog 1;
    ~*twitterbot 1;
    ~*whatsapp 1;
    ~*telegram 1;
    ~*telegrambot 1;
    ~*slack 1;
    ~*slackbot 1;
    ~*linkedinbot 1;
    ~*pinterest 1;
    ~*pinterestbot 1;
    ~*discordbot 1;
    ~*googlebot 1;
    ~*bingbot 1;
    ~*yandex 1;
    ~*baiduspider 1;
    ~*applebot 1;
    ~*vkexternalhit 1;
    ~*viber 1;
    ~*line 1;
    ~*wechat 1;
    ~*skype 1;
    "" 1;  # Empty user agent is often a bot
}

# Backend upstream server
upstream backend {
    server 10.0.0.3:3000;  # Replace with your backend server IP/port
    keepalive 32;
}

# Map for WebSocket upgrade
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
  server_name bandeja.me www.bandeja.me;

  root /home/relic/src/Frontend/dist;
  index index.html;

  # ---- Compression ----
  gzip on;
  gzip_vary on;
  gzip_min_length 1024;
  gzip_types
      text/plain
      text/css
      text/xml
      text/javascript
      application/javascript
      application/rss+xml
      application/json
      application/xml;

# ---- Apple App Site Association (Universal Links) ----
  location /.well-known/apple-app-site-association {
    default_type application/json;
    add_header Content-Type application/json;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
    gzip off;
    try_files $uri =404;
  }

# ---- Android App Links (Digital Asset Links) ----
  location /.well-known/assetlinks.json {
    default_type application/json;
    add_header Content-Type application/json;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
    gzip off;
    try_files $uri =404;
  }

  # ---- Game sharing with meta tags for bots ----
  # First, try to proxy bots to backend
  location ~ ^/games/[a-zA-Z0-9-]+$ {
    # Use error_page trick to redirect bots
    error_page 418 = @backend_meta;
    
    # If bot detected, return 418 which triggers @backend_meta
    if ($is_bot = 1) {
      return 418;
    }
    
    # For regular users, serve the SPA
    try_files $uri $uri/ /index.html;
  }

  # Named location for backend meta tags proxy (only for bots)
  location @backend_meta {
    proxy_pass http://backend$request_uri;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
  }

  # ---- Character Generator Models (handle /models/ requests from character generator) ----
  location /models/ {
    alias /home/relic/src_char/dist/models/;
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
  }

  # ---- Character Generator Static Assets (regex, must come before prefix location) ----
  location ~* ^/character/.+\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|json|wasm|bin|glb|fbx|obj|mtl|hdr|exr|ktx2|dds|basis|usdz|gltf)$ {
    root /home/relic/src_char/dist;
    rewrite ^/character/(.+)$ /$1 break;
    expires 1y;
    add_header Cache-Control "public, immutable";
  }

  # ---- Character Generator Assets (prefix match, handles /character/* requests) ----
  location ^~ /character/ {
    alias /home/relic/src_char/dist/;
    try_files $uri $uri/ @character_fallback;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
  }

  # ---- Character Generator Root ----
  location = /character {
    alias /home/relic/src_char/dist/index.html;
    default_type text/html;
    add_header Content-Type text/html;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
  }

  # ---- Character Generator Fallback (for SPA routing) ----
  location @character_fallback {
    rewrite ^/character(.*)$ /character/index.html last;
  }

  # ---- Static assets ----
  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
  }

  # ---- App landing page ----
  location ~ ^/link-to-app/?$ {
    try_files /link-to-app/index.html =404;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
  }

  # ---- SPA fallback ----
  location / {
    try_files $uri $uri/ /index.html;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
  }

  # ---- API reverse proxy ----
  location /api/ {
    proxy_pass http://backend/api/;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    client_max_body_size 10m;
    proxy_read_timeout 60s;
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;

    proxy_intercept_errors off; # let API return its own 4xx/5xx
  }


  # ---- UPLOADS reverse proxy ----
  location ^~ /uploads/ {
    proxy_pass http://backend;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    client_max_body_size 10m;
    proxy_read_timeout 60s;
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;

    proxy_intercept_errors off; # let API return its own 4xx/5xx
  }

  # ---- Socket.IO reverse proxy ----
  location /socket.io/ {
    proxy_pass http://backend/socket.io/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    proxy_buffering off;
  }

  # ---- Security headers ----
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/bandeja.me/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/bandeja.me/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}


server {
    if ($host = www.bandeja.me) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    if ($host = bandeja.me) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


  listen 80;
  listen [::]:80;
  server_name bandeja.me www.bandeja.me;
    return 404; # managed by Certbot




}
